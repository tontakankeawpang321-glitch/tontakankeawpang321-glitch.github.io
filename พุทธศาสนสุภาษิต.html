<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï AI (Gemini)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kodchasan:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    /* üé® ‡∏ò‡∏µ‡∏°‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ò‡∏µ‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢) */
    --bg:#fffdf5;         /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏≠‡πà‡∏≠‡∏ô */
    --ink:#2d2a26;        /* ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥‡πÄ‡∏ó‡∏≤ */
    --muted:#6b655b;      /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• */
    --line:#eaddcf;       /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡πÄ‡∏Ç‡πâ‡∏° */
    --brand:#b45309;      /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏à‡∏µ‡∏ß‡∏£/‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á (‡πÅ‡∏ó‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
    --brand-light:#fff7ed;
    --gold:#f59e0b;       /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
    --radius:16px;
    --shadow-sm:0 3px 0 rgba(180, 83, 9, 0.15), 0 8px 20px -12px rgba(0,0,0,.1);
    --shadow-inset: inset 0 2px 0 rgba(255,255,255,.9);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Sarabun", system-ui, sans-serif;
    font-size:15px; line-height: 1.6;
  }
  h1,h2,h3,h4{margin:0 0 8px; font-family: "Kodchasan", sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:12px 12px 80px;} /* padding-bottom ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ FAB */
  .section{margin-top:16px}

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á/‡∏Å‡∏≤‡∏£‡πå‡∏î */
  .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 10px 25px -20px rgba(0,0,0,.1)}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .row h3{color:var(--brand); font-weight:700;}
  .note{color:var(--muted);font-size:13px}

  /* ‡∏õ‡∏∏‡πà‡∏° 3D */
  .btn{
    appearance:none;border:1px solid #d7dbe6;background:linear-gradient(#ffffff,#fbf7f0);
    padding:10px 16px;border-radius:12px;cursor:pointer;color:var(--ink);font-weight:700;
    box-shadow:var(--shadow-sm),var(--shadow-inset);transform:translateY(0);
    transition:transform .05s, box-shadow .1s, filter .15s;
    font-family: "Kodchasan", sans-serif;
  }
  .btn:hover{filter:brightness(0.98)}
  .btn:active{transform:translateY(2px);box-shadow:inset 0 2px 0 rgba(0,0,0,.06)}
  .btn.primary{border-color:#fbbf24;background:linear-gradient(#fffbeb, #fcd34d); color:#78350f;}
  .btn.secondary{border-color:var(--line);}

  /* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
  .searchbar{display:flex;gap:8px;margin:8px 0 16px}
  .searchbar input{
    flex:1;height:48px;padding:0 16px;border:1px solid var(--line);border-radius:14px;
    background:#fff;box-shadow:inset 0 2px 6px rgba(0,0,0,.02); font-size:16px; font-family:"Sarabun";
  }
  .searchbar input:focus{outline:2px solid var(--brand); border-color:transparent;}

  /* ‡∏ä‡∏¥‡∏õ‡∏´‡∏°‡∏ß‡∏î (Tabs) */
  .catbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px}
  .chip{
    display:flex;align-items:center;gap:6px;justify-content:center;
    padding:12px 10px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(#ffffff,#fafafa);
    box-shadow:0 4px 10px -8px rgba(0,0,0,.1);
    cursor:pointer;font-weight:600;color:var(--muted);
    font-family: "Kodchasan", sans-serif;
  }
  .chip.active{
    border-color:#f59e0b; background:linear-gradient(#fffbeb,#fef3c7); 
    color:#92400e; box-shadow:0 2px 0 rgba(245, 158, 11, 0.3);
  }

  /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πå‡∏î */
  .list{display:grid;gap:12px;margin-top:12px}
  .card{
    border:1px solid var(--line);border-radius:14px;padding:16px;background:#fff;
    box-shadow:0 4px 12px -8px rgba(0,0,0,.08); transition: transform 0.2s;
  }
  .card:hover{transform:translateY(-2px); box-shadow:0 8px 20px -10px rgba(0,0,0,.15); border-color:var(--gold);}
  .title{margin:0 0 6px;font-size:18px; font-weight:700;color:var(--brand); line-height:1.4;}
  .sub-title{font-size: 16px; color: #444; margin-bottom: 8px;}
  .meta{display:flex;gap:6px;flex-wrap:wrap;color:var(--muted);font-size:13px; margin-bottom:8px;}
  .tag{background:#fff7ed;border:1px solid #ffedd5;border-radius:6px;padding:2px 8px; color:#9a3412;}

  .loadbar{display:flex;justify-content:center;gap:8px;margin-top:16px}
  .empty{padding:30px;text-align:center;color:var(--muted);border:2px dashed var(--line);border-radius:14px;background:rgba(255,255,255,0.5);}

  /* ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏™‡∏∏‡πà‡∏°‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï */
  .highlight-box{
    background: linear-gradient(135deg, #b45309, #78350f);
    color: #fff; padding: 20px; border-radius: var(--radius);
    text-align: center; position: relative; overflow: hidden;
    box-shadow: 0 10px 30px -10px rgba(180, 83, 9, 0.4);
  }
  .highlight-pali{ font-size: 22px; font-weight: 700; margin-bottom: 8px; font-family: "Kodchasan"; }
  .highlight-thai{ font-size: 16px; opacity: 0.9; }
  .highlight-badge{
    position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2);
    padding: 2px 8px; border-radius: 4px; font-size: 11px;
  }

  /* ===== CSS ‡∏Ç‡∏≠‡∏á Chatbot (Thai Law Style) ===== */
  #fab-chat-toggle {
    position: fixed; bottom: 24px; right: 24px;
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #b45309, #d97706); /* ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏ó‡∏≠‡∏á */
    color: white; border: none; border-radius: 50%;
    font-size: 28px; box-shadow: 0 8px 20px rgba(180, 83, 9, 0.4);
    cursor: pointer; z-index: 998;
    transition: transform 0.2s, opacity 0.3s;
    display: flex; align-items: center; justify-content: center;
  }
  #fab-chat-toggle:hover { transform: scale(1.1); }
  
  #chatbot-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 1000; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
    transition: opacity 0.3s; opacity: 1; pointer-events: auto;
    display: flex; justify-content: center; align-items: flex-end; /* Mobile bottom sheet style */
  }
  @media (min-width: 640px) {
    #chatbot-modal { align-items: center; }
  }
  #chatbot-modal.chatbot-hidden { opacity: 0; pointer-events: none; }
  
  .chat-window {
    width: 100%; max-width: 500px; height: 90vh;
    background: #fff; border-radius: 20px 20px 0 0;
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
  }
  @media (min-width: 640px) {
    .chat-window { height: 80vh; border-radius: 20px; }
  }

  /* Chat Bubbles */
  .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; position: relative; font-size: 15px; line-height: 1.5; }
  .chat-bubble-user { background: #b45309; color: white; border-bottom-right-radius: 4px; margin-left: auto; }
  .chat-bubble-model { background: #f3f4f6; color: #1f2937; border-bottom-left-radius: 4px; border: 1px solid #e5e7eb; }
  
  /* Thinking Animation */
  .gemini-thinking-bar {
    width: 40px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; position: relative;
  }
  .gemini-thinking-bar::after {
    content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 50%;
    background: #b45309; animation: slide 1s infinite ease-in-out alternate;
  }
  @keyframes slide { from { left: 0; } to { left: 50%; } }

</style>
</head>
<body>

<main class="wrap">
  <header style="text-align: center; margin-bottom: 20px;">
    <h1 style="color:var(--brand); font-size: 24px;">üôè ‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï</h1>
    <span class="note">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï ‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ-‡πÇ‡∏ó-‡πÄ‡∏≠‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</span>
  </header>

  <section class="section">
    <div class="highlight-box" id="highlightBox">
      <span class="highlight-badge">‡∏™‡∏∏‡πà‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï</span>
      <div class="highlight-pali" id="hl-pali">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      <div class="highlight-thai" id="hl-thai">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏∞</div>
    </div>
  </section>

  <section class="section">
    <div class="searchbar">
      <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏¥‡∏ï, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Å‡∏£‡∏ò, ‡∏ï‡∏ô)...">
      <button id="btnSearch" class="btn primary" type="button">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
    
    <div class="catbar" id="levelTabs">
      </div>
  </section>

  <section class="section panel">
    <div class="row" style="margin-bottom:12px;">
      <h3 id="panelTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï</h3>
      <span id="resultCount" class="note"></span>
    </div>
    <div id="list" class="list"></div>
    
    <div class="loadbar" id="pagination">
      <button id="btnPrev" class="btn secondary">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <span id="pageInfo" style="align-self:center; font-size:14px; color:var(--muted);"></span>
      <button id="btnNext" class="btn primary">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </section>
</main>

<button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏° AI ‡∏ò‡∏£‡∏£‡∏°‡∏∞">ü§ñ</button>

<div id="chatbot-modal" class="chatbot-hidden">
  <div class="chat-window">
    <header class="bg-orange-700 text-white p-4 flex justify-between items-center shadow-md">
      <div class="flex items-center gap-2">
        <span class="text-xl">‚ò∏Ô∏è</span>
        <div>
          <h1 class="text-lg font-bold m-0 text-white font-sans">AI ‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ò‡∏£‡∏£‡∏°</h1>
          <p class="text-xs text-orange-200 m-0">‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏≤</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="new-chat-btn" class="bg-orange-600 hover:bg-orange-800 text-white text-xs font-bold py-1 px-3 rounded">
          ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        </button>
        <button id="chatbot-close-btn" class="text-white hover:text-orange-200 font-bold text-xl px-2">
          &times;
        </button>
      </div>
    </header>

    <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model">
          <p>‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£‡πÇ‡∏¢‡∏°... ‡∏≠‡∏≤‡∏ï‡∏°‡∏≤‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï ‡∏´‡∏≤‡∏Å‡πÇ‡∏¢‡∏°‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πå‡πÉ‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏Ç‡πâ‡∏≠‡πÉ‡∏î ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
        </div>
      </div>
    </main>

    <div id="thinking-indicator" class="p-4 hidden bg-gray-50">
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model">
          <div class="gemini-thinking-bar"></div>
        </div>
      </div>
    </div>

    <footer class="bg-white p-3 border-t border-gray-200">
      <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏∞..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 font-sans">
        <button id="send-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-xl shadow-sm transition-colors">
          ‡∏™‡πà‡∏á
        </button>
      </div>
    </footer>
  </div>
</div>

<script>
/* =========================================
   1. ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (DATA HANDLER)
   ========================================= */
const DATA_URLS = {
  '‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ': 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/tontakankeawpang321-glitch.github.io/main/naktam_tri.json',
  '‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÇ‡∏ó': 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/tontakankeawpang321-glitch.github.io/main/naktam_to.json',
  '‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏≠‡∏Å': 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/tontakankeawpang321-glitch.github.io/main/naktam_ek.json'
};

let allProverbs = [];
let currentFilter = [];
let currentPage = 1;
const PAGE_SIZE = 10;
let currentLevel = '‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á Key ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
function normalizeKeys(obj){
  const map = {'‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á':'pali', '‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•':'thai', '‡∏´‡∏°‡∏ß‡∏î':'cat', '‡∏•‡∏≥‡∏î‡∏±‡∏ö':'id'};
  const newObj = {};
  for(let k in obj){
    let key = k.trim();
    if(map[key]) newObj[map[key]] = obj[k];
    else newObj[key] = obj[k];
  }
  return newObj;
}

async function loadData() {
  const highlightEl = document.getElementById('hl-pali');
  const highlightThaiEl = document.getElementById('hl-thai');
  
  try {
    const promises = Object.entries(DATA_URLS).map(async ([level, url]) => {
      const res = await fetch(url);
      const json = await res.json();
      const list = Array.isArray(json) ? json : (json.data || []);
      return list.map(item => ({ ...normalizeKeys(item), level }));
    });

    const results = await Promise.all(promises);
    allProverbs = results.flat();
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    renderChips();
    filterAndRender();
    showRandomHighlight();

  } catch (err) {
    console.error(err);
    highlightEl.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
    highlightThaiEl.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
    document.getElementById('list').innerHTML = `<div class="empty">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</div>`;
  }
}

/* =========================================
   2. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (UI RENDERER)
   ========================================= */
const listEl = document.getElementById('list');
const pageInfo = document.getElementById('pageInfo');
const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');

function renderChips() {
  const tabs = document.getElementById('levelTabs');
  tabs.innerHTML = Object.keys(DATA_URLS).map(lvl => `
    <button class="chip ${lvl===currentLevel?'active':''}" onclick="switchLevel('${lvl}')">
      üìö ${lvl}
    </button>
  `).join('');
}

function switchLevel(lvl) {
  currentLevel = lvl;
  currentPage = 1;
  document.getElementById('q').value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏±‡πâ‡∏ô
  renderChips();
  filterAndRender();
}

function filterAndRender() {
  const q = document.getElementById('q').value.trim().toLowerCase();
  
  // Logic: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô
  if (q) {
    currentFilter = allProverbs.filter(item => 
      (item.pali && item.pali.toLowerCase().includes(q)) || 
      (item.thai && item.thai.toLowerCase().includes(q)) ||
      (item.cat && item.cat.toLowerCase().includes(q))
    );
    document.getElementById('panelTitle').textContent = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${q}"`;
  } else {
    currentFilter = allProverbs.filter(item => item.level === currentLevel);
    document.getElementById('panelTitle').textContent = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${currentLevel}`;
  }

  document.getElementById('resultCount').textContent = `${currentFilter.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(currentFilter.length / PAGE_SIZE) || 1;
  if (currentPage > totalPages) currentPage = totalPages;
  
  const start = (currentPage - 1) * PAGE_SIZE;
  const end = start + PAGE_SIZE;
  const itemsToShow = currentFilter.slice(start, end);

  if (itemsToShow.length === 0) {
    listEl.innerHTML = `<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
    pageInfo.textContent = "";
    btnPrev.style.display = 'none';
    btnNext.style.display = 'none';
    return;
  }

  listEl.innerHTML = itemsToShow.map(item => `
    <article class="card">
      <h4 class="title">${item.pali || '-'}</h4>
      <div class="sub-title">${item.thai || '-'}</div>
      <div class="meta">
        ${item.level ? `<span class="tag" style="background:#e0f2fe; border-color:#bae6fd; color:#0369a1;">${item.level}</span>` : ''}
        ${item.cat ? `<span class="tag">‡∏´‡∏°‡∏ß‡∏î: ${item.cat}</span>` : ''}
        ${item.id ? `<span class="tag" style="background:#f3f4f6; border-color:#e5e7eb; color:#4b5563;">‡∏•‡∏≥‡∏î‡∏±‡∏ö: ${item.id}</span>` : ''}
      </div>
    </article>
  `).join('');

  pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} / ${totalPages}`;
  btnPrev.style.display = currentPage > 1 ? 'inline-block' : 'none';
  btnNext.style.display = currentPage < totalPages ? 'inline-block' : 'none';
}

function showRandomHighlight() {
  if(!allProverbs.length) return;
  const r = allProverbs[Math.floor(Math.random() * allProverbs.length)];
  document.getElementById('hl-pali').textContent = r.pali || '';
  document.getElementById('hl-thai').textContent = r.thai || '';
}

// Event Listeners UI
document.getElementById('btnSearch').onclick = filterAndRender;
document.getElementById('q').onkeyup = (e) => { if(e.key === 'Enter') filterAndRender(); };
btnPrev.onclick = () => { if(currentPage > 1) { currentPage--; renderPagination(); window.scrollTo(0,300); }};
btnNext.onclick = () => { currentPage++; renderPagination(); window.scrollTo(0,300); };


/* =========================================
   3. ‡∏™‡πà‡∏ß‡∏ô Chatbot AI (Backend ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Law AI)
   ========================================= */
// üîí ‡πÉ‡∏ä‡πâ Backend ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
const BACKEND_URL = 'https://us-central1-law-ai-14740.cloudfunctions.net/api/chat';

// ‡∏™‡∏£‡πâ‡∏≤‡∏á System Prompt ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Override ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å (Client-Side Injection)
const SYSTEM_CONTEXT = {
  role: "user",
  parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ 'AI ‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ò‡∏£‡∏£‡∏°' ‡∏´‡∏£‡∏∑‡∏≠ '‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå AI' ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï ‡∏´‡∏•‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏° ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏• ‡∏°‡∏µ‡πÄ‡∏°‡∏ï‡∏ï‡∏≤ (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£' ‡πÅ‡∏ó‡∏ô‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ) ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ò‡∏£‡∏£‡∏°‡∏∞ ‡πÉ‡∏´‡πâ‡∏ß‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏∞‡πÄ‡∏™‡∏°‡∏≠" }]
};

const ACK_CONTEXT = {
  role: "model",
  parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£ ‡∏≠‡∏≤‡∏ï‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß" }]
};

let chatHistory = [SYSTEM_CONTEXT, ACK_CONTEXT];

const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');

function addChatBubble(text, isUser) {
  const div = document.createElement('div');
  div.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
  div.innerHTML = `
    <span class="text-2xl">${isUser ? 'üë§' : 'ü§ñ'}</span>
    <div class="chat-bubble ${isUser ? 'chat-bubble-user' : 'chat-bubble-model'}">
      ${text.replace(/\n/g, '<br>')}
    </div>
  `;
  chatHistoryEl.appendChild(div);
  chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

async function handleSend() {
  const text = userInput.value.trim();
  if (!text) return;

  userInput.value = '';
  addChatBubble(text, true);
  
  thinkingIndicator.classList.remove('hidden');
  chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
  sendBtn.disabled = true;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  chatHistory.push({ role: "user", parts: [{ text: text }] });

  try {
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ history: chatHistory }) // ‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ System Prompt ‡πÅ‡∏ù‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    });

    if (!res.ok) throw new Error("Server Error");

    const data = await res.json();
    const reply = data.reply;

    thinkingIndicator.classList.add('hidden');
    addChatBubble(reply, false);
    chatHistory.push({ role: "model", parts: [{ text: reply }] });

  } catch (err) {
    console.error(err);
    thinkingIndicator.classList.add('hidden');
    addChatBubble("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏≠‡∏≤‡∏ï‡∏°‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡πÇ‡∏¢‡∏°", false);
    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
    chatHistory.pop();
  } finally {
    sendBtn.disabled = false;
  }
}

// Chat UI Controls
const modal = document.getElementById('chatbot-modal');
const fab = document.getElementById('fab-chat-toggle');

fab.onclick = () => {
  modal.classList.remove('chatbot-hidden');
  fab.style.opacity = '0';
};
document.getElementById('chatbot-close-btn').onclick = () => {
  modal.classList.add('chatbot-hidden');
  fab.style.opacity = '1';
};
document.getElementById('new-chat-btn').onclick = () => {
  chatHistory = [SYSTEM_CONTEXT, ACK_CONTEXT]; // Reset ‡∏û‡∏£‡πâ‡∏≠‡∏° System Prompt ‡πÄ‡∏î‡∏¥‡∏°
  chatHistoryEl.innerHTML = `
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model">
          <p>‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏û‡∏£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏ö‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
        </div>
      </div>
  `;
};
sendBtn.onclick = handleSend;
userInput.onkeydown = (e) => { if(e.key === 'Enter') handleSend(); };

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
loadData();

</script>
</body>
</html>
