<!DOCTYPE html>  
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï ‚Äì Dialog UI (White ¬∑ Montserrat 12px)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Press+Start+2P&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f8fc; --ink:#0f172a; --muted:#4b5563; --line:#e7eaf0; --card:#ffffff;
    --brand:#195fcb; --accent:#0ea5e9;
    --radius:12px; --shadow-soft:0 10px 28px rgba(15,23,42,.08); --shadow-soft-2:0 2px 0 rgba(15,23,42,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; background:linear-gradient(180deg,#fbfcff 0%,#f3f6fb 100%); color:var(--ink); font-family:"Sarabun",system-ui; line-height:1.6; }
  .wrap{max-width:1080px; margin:0 auto; padding:20px;}

  header{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
  .logo{ font-family:"Press Start 2P", monospace; font-size:14px; letter-spacing:1px; color:var(--brand); text-shadow:0 1px 0 #fff; }

  .ghost-btn{ appearance:none; border:1px solid rgba(25,95,203,.35); background:rgba(255,255,255,.7); -webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px); color:var(--ink); padding:10px 14px; font-weight:700; border-radius:12px; box-shadow:var(--shadow-soft-2); cursor:pointer; transition:transform .08s ease, box-shadow .12s ease, border-color .12s; }
  .ghost-btn:hover{ box-shadow:0 6px 18px rgba(15,23,42,.08); border-color:rgba(25,95,203,.55); }
  .ghost-btn:active{ transform:translateY(1px); }
  .ghost-btn--brand{ border-color:rgba(25,95,203,.75); color:#0b4f9a; }

  .chip-bar{display:flex; flex-wrap:wrap; gap:8px;}
  .chip{ padding:8px 12px; background:#fff; border:1px solid var(--line); color:var(--ink); border-radius:999px; cursor:pointer; box-shadow:var(--shadow-soft-2); transition:background .12s, border-color .12s, transform .08s; }
  .chip:hover{ transform:translateY(-1px); }
  .chip.is-active{ background:#e8f2ff; border-color:#b7d3fb; color:#0b4f9a; }

  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .spacer{flex:1}

  .search,.select{ background:#fff; color:var(--ink); border:1px solid var(--line); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow-soft-2); }
  .search{ width:280px; max-width:100%; }

  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px; margin-top:18px;}
  @media (max-width:900px){ .grid{ grid-template-columns:repeat(8,1fr);} }
  @media (max-width:640px){ .grid{ grid-template-columns:repeat(6,1fr);} }
  .card{ grid-column:span 6; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow-soft); padding:16px; transition:transform .08s ease, box-shadow .12s ease; }
  .card:hover{ transform:translateY(-1px); box-shadow:0 14px 34px rgba(15,23,42,.1); }

  .from-sheet{ font-family:"Montserrat","Sarabun",system-ui; font-size:12px; }
  .meta{ font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .meta .tag{ background:#f1f5f9; border:1px solid #e2e8f0; padding:4px 8px; border-radius:999px; box-shadow:var(--shadow-soft-2); font-weight:600; }
  .pali{ margin:6px 0 0; }
  .trans{ background:#f8fafc; padding:10px; border:1px dashed #dbeafe; margin-top:10px; border-radius:8px; white-space:pre-wrap; }

  dialog{ width:min(860px,96vw); border:1px solid var(--line); border-radius:18px; padding:0; background:#ffffff; color:var(--ink); box-shadow:0 28px 80px rgba(15,23,42,.2); }
  dialog::backdrop{ background:rgba(0,0,0,.35); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); }
  .dlg-head{ padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; }
  .dlg-head h2{ margin:0; font-family:"Press Start 2P"; font-size:13px; color:#0b4f9a; letter-spacing:.4px; }
  .dlg-body{ max-height:min(70vh,560px); overflow:auto; padding:16px; }
  .dlg-foot{ padding:12px 16px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; }

  .subgrid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  @media (max-width:640px){ .subgrid{ grid-template-columns:repeat(2,1fr);} }
  .subcat{ padding:10px; border:1px solid var(--line); background:#ffffff; cursor:pointer; text-align:center; border-radius:12px; box-shadow:var(--shadow-soft-2); transition:transform .08s, box-shadow .12s; }
  .subcat:hover{ transform:translateY(-1px); box-shadow:0 10px 20px rgba(15,23,42,.08); }
  .subcat.is-active{ outline:2px solid #b7d3fb; }

  body.lock{ overflow:hidden; position:fixed; width:100%; }

  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏à‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
  #pager{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px;}
  #pager .pbtn{border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; box-shadow:var(--shadow-soft-2);}
  #pager .pbtn[disabled]{opacity:.5; cursor:not-allowed;}
  #pager .pcounter{font-size:12px; color:var(--muted);}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏©‡∏¥‡∏ï</div>
      <button id="openDlg" class="ghost-btn ghost-btn--brand">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î</button>
      <div class="spacer"></div>
      <div class="chip-bar" id="levelChips">
        <button class="chip is-active" data-level="‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ">‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ</button>
        <button class="chip" data-level="‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÇ‡∏ó">‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÇ‡∏ó</button>
        <button class="chip" data-level="‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏≠‡∏Å">‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏≠‡∏Å</button>
      </div>
    </header>

    <div class="row" style="margin-top:12px;">
      <input id="q" class="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‚Ä¶ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter)"/>
      <select id="sorter" class="select">
        <option value="no">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö</option>
        <option value="cat">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î</option>
      </select>
      <button id="btnRefresh" class="ghost-btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <section class="grid" id="list"></section>
    <!-- ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏û‡∏à‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏°) -->
    <div id="pager" aria-label="‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤" hidden>
      <button id="prevPage" class="pbtn">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
      <span class="pcounter" id="pageInfo"></span>
      <button id="nextPage" class="pbtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </div>

  <!-- Dialog ‡πÄ‡∏î‡∏¥‡∏°: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î -->
  <dialog id="dlgCats">
    <div class="dlg-head">
      <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î / ‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢</h2>
      <button id="closeDlg" class="ghost-btn">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="dlg-body">
      <div class="row" style="margin-bottom:12px;">
        <div style="font-weight:700;">‡∏£‡∏∞‡∏î‡∏±‡∏ö:</div>
        <div class="chip-bar" id="dlgLevelChips"></div>
      </div>
      <div class="row" style="margin-bottom:6px;"><div style="font-weight:700;">‡∏´‡∏°‡∏ß‡∏î:</div></div>
      <div id="cats" class="subgrid"></div>
      <div class="row" style="margin:16px 0 6px;"><div style="font-weight:700;">‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢:</div></div>
      <div id="subcats" class="subgrid"></div>
    </div>
    <div class="dlg-foot">
      <button class="ghost-btn" id="clearFilter">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
      <button class="ghost-btn ghost-btn--brand" id="applyFilter">‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ</button>
    </div>
  </dialog>

  <!-- Dialog ‡πÉ‡∏´‡∏°‡πà: ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠ (‡πÄ‡∏û‡∏¥‡πà‡∏°) -->
  <dialog id="dlgInfo" aria-modal="true">
    <div class="dlg-head">
      <h2>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠</h2>
      <button id="closeInfo" class="ghost-btn">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="dlg-body">
      <div id="infoContent" class="from-sheet"></div>
    </div>
    <div class="dlg-foot">
      <button id="okInfo" class="ghost-btn ghost-btn--brand">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
    </div>
  </dialog>

<!-- üß† SCRIPT SECTION ‚Äì ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å HTML ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzIGnlkPk4xiH33NnXlH9yWsmsABe06mL-3i7Of9F00EHKp6u6Vn89YNYLekTrgtFpL/exec'; // ‚öôÔ∏è ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°

// === STATE ‡πÄ‡∏î‡∏¥‡∏° + ‡πÄ‡∏û‡∏à‡πÉ‡∏´‡∏°‡πà ===
let state = { level: '‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ', category: '', subcategory: '', q: '', sort: 'no', cats: [], subcats: [] };
let temp = null;
let allItems = [];        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å API
let page = 1;             // ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
const pageSize = 5;       // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πâ‡∏≤

// REFS ‡πÄ‡∏î‡∏¥‡∏°
const listEl = document.getElementById('list');
const dlg = document.getElementById('dlgCats');
const dlgLevelChips = document.getElementById('dlgLevelChips');
const catsEl = document.getElementById('cats');
const subcatsEl = document.getElementById('subcats');
const qEl = document.getElementById('q');
const sorterEl = document.getElementById('sorter');

// REFS ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏à + info)
const pagerEl = document.getElementById('pager');
const prevBtn = document.getElementById('prevPage');
const nextBtn = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');
const dlgInfo = document.getElementById('dlgInfo');
const infoContent = document.getElementById('infoContent');

// HELPERS ‡πÄ‡∏î‡∏¥‡∏°
const escapeHtml = s => String(s||'').replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const pixelTag = t => `<span class="tag from-sheet">${escapeHtml(t)}</span>`;

// === UNIVERSAL API (‡πÄ‡∏î‡∏¥‡∏°) ===
async function api(action, params = {}) {
  if (window.google && google.script && google.script.run)
    return new Promise((ok, err)=>{
      const run = google.script.run.withSuccessHandler(ok).withFailureHandler(err);
      if (action==='categories') run.apiCategories(params.level);
      else if (action==='subcategories') run.apiSubcategories(params.level, params.category||'');
      else run.apiList(params);
    });

  try {
    const url = WEB_APP_URL + '?' + new URLSearchParams({action, ...params}).toString();
    const res = await fetch(url);
    return await res.json();
  } catch {
    // JSONP fallback
    return new Promise((resolve, reject)=>{
      const cb='cb'+Math.random().toString(36).slice(2);
      window[cb]=(d)=>{resolve(d);cleanup();};
      const s=document.createElement('script');
      s.src=WEB_APP_URL+'?action='+action+'&callback='+cb+'&'+new URLSearchParams(params);
      s.onerror=()=>{reject(new Error('JSONP error'));cleanup();};
      function cleanup(){delete window[cb];s.remove();}
      document.body.appendChild(s);
    });
  }
}

// === ‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äú‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠‚Äù ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (on-the-fly) ‡πÇ‡∏î‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ ===
function buildSummary(item){
  // ‡∏ï‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó
  const pali = (item.pali||'').trim();
  const trans = (item.trans||'').trim();
  const speaker = (item.speaker||'').trim();
  const source = (item.source||'').trim();

  const transShort = trans.length>180 ? trans.slice(0,180)+'‚Ä¶' : trans;
  const parts = [];
  if (pali) parts.push(`‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${escapeHtml(pali)}`);
  if (transShort) parts.push(`‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°: ${escapeHtml(transShort)}`);
  const metaBits = [];
  if (item.category) metaBits.push(`‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(item.category)}`);
  if (item.subcategory) metaBits.push(`‡∏¢‡πà‡∏≠‡∏¢: ${escapeHtml(item.subcategory)}`);
  if (speaker) metaBits.push(`‡∏ú‡∏π‡πâ‡∏Å‡∏•‡πà‡∏≤‡∏ß: ${escapeHtml(speaker)}`);
  if (source) metaBits.push(`‡∏ó‡∏µ‡πà‡∏°‡∏≤: ${escapeHtml(source)}`);
  if (metaBits.length) parts.push(metaBits.join(' ¬∑ '));

  return `<div class="meta" style="margin-bottom:8px;">${pixelTag('‡∏•‡∏≥‡∏î‡∏±‡∏ö '+escapeHtml(item.no||''))}</div>
          <div class="from-sheet" style="white-space:pre-wrap;">${parts.join('\n')}</div>`;
}

// === RENDER (‡πÄ‡∏û‡∏¥‡πà‡∏° data-idx ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î dialog) ===
function cardTemplate(it, idx){
  return `<article class="card" data-idx="${idx}" role="button" tabindex="0" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠">
    <div class="meta from-sheet">${pixelTag('‡∏•‡∏≥‡∏î‡∏±‡∏ö '+escapeHtml(it.no))}${pixelTag('‡∏´‡∏°‡∏ß‡∏î '+escapeHtml(it.category))}${it.subcategory?pixelTag('‡∏¢‡πà‡∏≠‡∏¢ '+escapeHtml(it.subcategory)):''}</div>
    <div class="pali from-sheet">${escapeHtml(it.pali)}</div>
    ${it.trans?`<div class="trans from-sheet">${escapeHtml(it.trans)}</div>`:''}
    ${(it.speaker||it.source)?`<div class="meta from-sheet" style="margin-top:8px;">${it.speaker?pixelTag('‡∏ú‡∏π‡πâ‡∏Å‡∏•‡πà‡∏≤‡∏ß '+escapeHtml(it.speaker)):''}${it.source?pixelTag('‡∏ó‡∏µ‡πà‡∏°‡∏≤ '+escapeHtml(it.source)):''}</div>`:''}
  </article>`;
}

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πâ‡∏≤
function renderPage(){
  const total = allItems.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (page > totalPages) page = totalPages;
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, total);
  const view = allItems.slice(start, end);

  listEl.innerHTML = view.map((it, i)=> cardTemplate(it, start + i)).join('');
  pagerEl.hidden = total <= pageSize;
  pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages}`;
  prevBtn.disabled = page <= 1;
  nextBtn.disabled = page >= totalPages;
}

// === ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤ ===
async function refreshList(){
  listEl.innerHTML = '<div class="card from-sheet">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>';
  try{
    const d = await api('list', state);
    allItems = (d && d.items) || [];
    if (!allItems.length){
      listEl.innerHTML = '<div class="card from-sheet">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      pagerEl.hidden = true;
      return;
    }
    page = 1;       // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
    renderPage();
  }catch(e){
    listEl.innerHTML = `<div class="card from-sheet" style="background:#fff1f2;border-color:#fca5a5;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${escapeHtml(e.message)}</div>`;
    pagerEl.hidden = true;
  }
}

// === ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î/‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (‡πÄ‡∏î‡∏¥‡∏°) ===
async function loadCats(){ const d = await api('categories',{level:temp.level}); temp.cats = d.categories || []; renderCats(); }
async function loadSubcats(){ const d = await api('subcategories',{level:temp.level,category:temp.category}); temp.subcats = d.subcategories || []; renderSubcats(); }

function renderLevelChips(){
  const lv=['‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ','‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÇ‡∏ó','‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏≠‡∏Å'];
  document.getElementById('levelChips').innerHTML=lv.map(l=>`<button class="chip ${l===state.level?'is-active':''}" data-level="${l}">${l}</button>`).join('');
}
function renderDlgLevelChips(){
  const lv=['‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏µ','‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÇ‡∏ó','‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏≠‡∏Å'];
  dlgLevelChips.innerHTML=lv.map(l=>`<button class="chip ${l===(temp?.level||state.level)?'is-active':''}" data-dlg-level="${l}">${l}</button>`).join('');
}
function renderCats(){ catsEl.innerHTML=(temp?.cats||[]).map(c=>`<div class="subcat ${c===temp.category?'is-active':''}" data-cat="${c}">${escapeHtml(c)}</div>`).join(''); }
function renderSubcats(){
  const sc=temp?.subcats||[];
  subcatsEl.innerHTML=sc.length?sc.map(s=>`<div class="subcat ${s===temp.subcategory?'is-active':''}" data-subcat="${s}">${escapeHtml(s)}</div>`).join('')
    :'<div class="subcat" style="opacity:.6">(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢)</div>';
}

// === ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î dialog ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏î‡∏¥‡∏°) ===
document.getElementById('openDlg').onclick=async()=>{
  temp=JSON.parse(JSON.stringify(state));
  renderDlgLevelChips();await loadCats();await loadSubcats();
  dlg.showModal();document.body.classList.add('lock');
};
document.getElementById('closeDlg').onclick=()=>{dlg.close();document.body.classList.remove('lock');};
document.getElementById('applyFilter').onclick=()=>{state=JSON.parse(JSON.stringify(temp));dlg.close();renderLevelChips();refreshList();};
document.getElementById('clearFilter').onclick=()=>{temp.category='';temp.subcategory='';renderCats();renderSubcats();};

// === ‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î dialog ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡πà‡∏≠ (‡πÉ‡∏´‡∏°‡πà) ===
document.addEventListener('click', ev=>{
  // level chips (‡πÄ‡∏î‡∏¥‡∏°)
  const l=ev.target.closest('.chip[data-level]'); 
  if(l){ state.level=l.dataset.level; renderLevelChips(); refreshList(); return; }

  const dchip=ev.target.closest('.chip[data-dlg-level]');
  if(dchip){ temp.level=dchip.dataset.dlgLevel; renderDlgLevelChips(); loadCats().then(loadSubcats); return; }

  const c=ev.target.closest('.subcat[data-cat]'); 
  if(c){ temp.category=c.dataset.cat; loadSubcats(); renderCats(); return; }

  const s=ev.target.closest('.subcat[data-subcat]'); 
  if(s){ temp.subcategory=s.dataset.subcat; renderSubcats(); return; }

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏£‡∏∏‡∏õ
  const card = ev.target.closest('.card[data-idx]');
  if (card){
    const idx = Number(card.dataset.idx);
    const item = allItems[idx];
    infoContent.innerHTML = buildSummary(item);
    dlgInfo.showModal();
    document.body.classList.add('lock');
  }
});

// ‡∏õ‡∏¥‡∏î dialog ‡∏™‡∏£‡∏∏‡∏õ
document.getElementById('closeInfo').onclick = ()=>{
  dlgInfo.close();
  document.body.classList.remove('lock');
};
document.getElementById('okInfo').onclick = ()=>{
  dlgInfo.close();
  document.body.classList.remove('lock');
};

// ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡πÄ‡∏î‡∏¥‡∏°) + ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
document.getElementById('btnRefresh').onclick=refreshList;
qEl.onkeydown=e=>{ if(e.key==='Enter'){ state.q=qEl.value.trim(); refreshList(); } };
sorterEl.onchange=()=>{ state.sort=sorterEl.value; refreshList(); };

// ‡πÄ‡∏û‡∏à (‡πÉ‡∏´‡∏°‡πà)
prevBtn.onclick = ()=>{ if(page>1){ page--; renderPage(); } };
nextBtn.onclick = ()=>{ const totalPages = Math.max(1, Math.ceil(allItems.length/pageSize)); if(page<totalPages){ page++; renderPage(); } };

// ESC ‡∏õ‡∏¥‡∏î dialog ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏î‡∏¥‡∏°)
window.addEventListener('keydown', (e)=>{ 
  if (e.key==='Escape' && dlg.open){ dlg.close(); document.body.classList.remove('lock'); } 
  if (e.key==='Escape' && dlgInfo.open){ dlgInfo.close(); document.body.classList.remove('lock'); }
});

// === Init (‡πÄ‡∏î‡∏¥‡∏°) ===
renderLevelChips();
refreshList();
</script>
<a    class="dlg-head"  href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%81%E0%B8%A3%E0%B8%81" target="_blank"> <div class="title">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß Privacy policy
</div>  </a>
    </div>
</div>
</body>
</html>
