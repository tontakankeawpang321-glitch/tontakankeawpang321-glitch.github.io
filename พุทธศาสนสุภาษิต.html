<!DOCTYPE html> 
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>พุทธศาสนสุภาษิต – Live Data Version</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Press+Start+2P&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f8fc; --ink:#0f172a; --muted:#4b5563; --line:#e7eaf0; --card:#ffffff;
    --brand:#195fcb; --accent:#0ea5e9;
    --radius:12px; --shadow-soft:0 10px 28px rgba(15,23,42,.08); --shadow-soft-2:0 2px 0 rgba(15,23,42,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ 
    margin:0; 
    background:linear-gradient(180deg,#fbfcff 0%,#f3f6fb 100%); 
    color:var(--ink); 
    font-family:"Sarabun",system-ui; 
    line-height:1.6; 
    font-size: 14px;
  }
  .wrap{max-width:1080px; margin:0 auto; padding:20px;}
  header{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
  .logo{ font-family:"Press Start 2P", monospace; font-size:14px; letter-spacing:1px; color:var(--brand); text-shadow:0 1px 0 #fff; }
  .ghost-btn{ appearance:none; border:1px solid rgba(25,95,203,.35); background:rgba(255,255,255,.7); -webkit-backdrop-filter:blur(10px); backdrop-filter:blur(10px); color:var(--ink); padding:10px 14px; font-weight:700; border-radius:12px; box-shadow:var(--shadow-soft-2); cursor:pointer; transition:transform .08s ease, box-shadow .12s ease, border-color .12s; }
  .ghost-btn:hover{ box-shadow:0 6px 18px rgba(15,23,42,.08); border-color:rgba(25,95,203,.55); }
  .ghost-btn:active{ transform:translateY(1px); }
  .ghost-btn--brand{ border-color:rgba(25,95,203,.75); color:#0b4f9a; }
  .chip-bar{display:flex; flex-wrap:wrap; gap:8px;}
  .chip{ padding:8px 12px; background:#fff; border:1px solid var(--line); color:var(--ink); border-radius:999px; cursor:pointer; box-shadow:var(--shadow-soft-2); transition:background .12s, border-color .12s, transform .08s; }
  .chip:hover{ transform:translateY(-1px); }
  .chip.is-active{ background:#e8f2ff; border-color:#b7d3fb; color:#0b4f9a; }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .spacer{flex:1}
  .search,.select{ background:#fff; color:var(--ink); border:1px solid var(--line); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow-soft-2); }
  .search{ width:280px; max-width:100%; }
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:16px; margin-top:18px;}
  .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow-soft); padding:16px; transition:transform .08s ease, box-shadow .12s ease; cursor: pointer; }
  .card:hover{ transform:translateY(-1px); box-shadow:0 14px 34px rgba(15,23,42,.1); }
  .from-sheet{ font-family:"Montserrat","Sarabun",system-ui; }
  .meta{ color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .meta .tag{ background:#f1f5f9; border:1px solid #e2e8f0; padding:4px 8px; border-radius:999px; box-shadow:var(--shadow-soft-2); font-weight:600; }
  .pali{ margin:6px 0 0; }
  .trans{ background:#f8fafc; padding:10px; border:1px dashed #dbeafe; margin-top:10px; border-radius:8px; white-space:pre-wrap; }
  dialog{ width:min(860px,96vw); border:1px solid var(--line); border-radius:18px; padding:0; background:#ffffff; color:var(--ink); box-shadow:0 28px 80px rgba(15,23,42,.2); }
  dialog::backdrop{ background:rgba(0,0,0,.35); -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px); }
  .dlg-head{ padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; }
  .dlg-head h2{ margin:0; font-family:"Press Start 2P"; font-size:13px; color:#0b4f9a; letter-spacing:.4px; }
  .dlg-body{ max-height:min(70vh,560px); overflow:auto; padding:16px; }
  .dlg-foot{ padding:12px 16px; border-top:1px solid var(--line); display:flex; justify-content:flex-end; gap:10px; }
  .subgrid{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  @media (max-width:640px){ .subgrid{ grid-template-columns:repeat(2,1fr);} }
  .subcat{ padding:10px; border:1px solid var(--line); background:#ffffff; cursor:pointer; text-align:center; border-radius:12px; box-shadow:var(--shadow-soft-2); transition:transform .08s, box-shadow .12s; }
  .subcat:hover{ transform:translateY(-1px); box-shadow:0 10px 20px rgba(15,23,42,.08); }
  .subcat.is-active{ outline:2px solid #b7d3fb; }
  body.lock{ overflow:hidden; position:fixed; width:100%; }
  #pager{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px;}
  #pager .pbtn{border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; box-shadow:var(--shadow-soft-2);}
  #pager .pbtn[disabled]{opacity:.5; cursor:not-allowed;}
  #pager .pcounter{color:var(--muted);}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">พุทธศาสนสุภาษิต</div>
      <button id="openDlg" class="ghost-btn ghost-btn--brand">เลือกหมวด</button>
      <div class="spacer"></div>
      <div class="chip-bar" id="levelChips"></div>
    </header>

    <div class="row" style="margin-top:12px;">
      <input id="q" class="search" placeholder="ค้นหาเรื่อง/คำแปล…"/>
      <select id="sorter" class="select">
        <option value="no">เรียงตามลำดับ</option>
        <option value="cat">เรียงตามหมวด</option>
      </select>
      <button id="btnSearch" class="ghost-btn" title="ค้นหา">ค้นหา</button>
    </div>

    <section class="grid" id="list"></section>
    <div id="pager" aria-label="ตัวแบ่งหน้า" hidden>
      <button id="prevPage" class="pbtn">ก่อนหน้า</button>
      <span class="pcounter" id="pageInfo"></span>
      <button id="nextPage" class="pbtn">ถัดไป</button>
    </div>
  </div>

  <dialog id="dlgCats">
    <div class="dlg-head">
      <h2>เลือกหมวด / หมวดย่อย</h2>
      <button id="closeDlg" class="ghost-btn">ปิด</button>
    </div>
    <div class="dlg-body">
      <div class="row" style="margin-bottom:12px;"><div style="font-weight:700;">ระดับ:</div><div class="chip-bar" id="dlgLevelChips"></div></div>
      <div class="row" style="margin-bottom:6px;"><div style="font-weight:700;">หมวด:</div></div>
      <div id="cats" class="subgrid"></div>
      <div class="row" style="margin:16px 0 6px;"><div style="font-weight:700;">หมวดย่อย:</div></div>
      <div id="subcats" class="subgrid"></div>
    </div>
    <div class="dlg-foot">
      <button class="ghost-btn" id="clearFilter">ล้างตัวกรอง</button>
      <button class="ghost-btn ghost-btn--brand" id="applyFilter">นำไปใช้</button>
    </div>
  </dialog>

  <dialog id="dlgInfo" aria-modal="true">
    <div class="dlg-head">
      <h2>รายละเอียด</h2>
      <button id="closeInfo" class="ghost-btn">ปิด</button>
    </div>
    <div class="dlg-body"><div id="infoContent" class="from-sheet"></div></div>
    <div class="dlg-foot"><button id="okInfo" class="ghost-btn ghost-btn--brand">โอเค</button></div>
  </dialog>

<script>
// === CONFIG ===
const DATA_FILES = {
  'นักธรรมตรี': 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/tontakankeawpang321-glitch.github.io/main/naktam_tri.json',
  'นักธรรมโท': 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/tontakankeawpang321-glitch.github.io/main/naktam_to.json',
  'นักธรรมเอก': 'https://raw.githubusercontent.com/tontakankeawpang321-glitch/tontakankeawpang321-glitch.github.io/main/naktam_ek.json'
};

// === STATE & REFS ===
let ALL_DATA = {};
let state = { level:'นักธรรมตรี', category:'', subcategory:'', q:'', sort:'no' };
let currentLevelData = [];
let filteredItems = [];
let page = 1;
const pageSize = 5;

const listEl   = document.getElementById('list');
const qEl      = document.getElementById('q');
const sorterEl = document.getElementById('sorter');
const pagerEl  = document.getElementById('pager');
const prevBtn  = document.getElementById('prevPage');
const nextBtn  = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');
const dlg      = document.getElementById('dlgCats');
const dlgInfo  = document.getElementById('dlgInfo');
const infoContent = document.getElementById('infoContent');
const dlgLevelChips = document.getElementById('dlgLevelChips');
const catsEl   = document.getElementById('cats');
const subcatsEl= document.getElementById('subcats');

// === UTILS ===
const escapeHtml = s => String(s ?? '').replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const pixelTag   = t => `<span class="tag from-sheet">${escapeHtml(t)}</span>`;

const NKMAP = {
  'ลำดับ':'ลำดับ', 'หมวด':'หมวด', 'เรื่อง':'เรื่อง', 'คำแปล':'คำแปล', 'ที่มา':'ที่มา'
};
function normalizeKeys(obj){
  const out = {};
  for(const k in obj){
    const clean = k.replace(/^\uFEFF|\s+$/g,'');
    const mapped = NKMAP[clean] ?? clean;
    out[mapped] = obj[k];
  }
  out['ลำดับ'] = out['ลำดับ'] != null ? String(out['ลำดับ']) : '';
  out['หมวด']  = out['หมวด']  != null ? String(out['หมวด'])  : '';
  out['เรื่อง'] = out['เรื่อง'] != null ? String(out['เรื่อง']) : '';
  out['คำแปล'] = out['คำแปล'] != null ? String(out['คำแปล']) : '';
  return out;
}

// === LOADERS ===
async function loadAllDataFromFiles(){
  if (Object.keys(ALL_DATA).length) return;
  listEl.innerHTML = '<div class="card from-sheet">กำลังโหลดข้อมูล…</div>';
  const entries = Object.entries(DATA_FILES);
  try{
    const results = await Promise.all(entries.map(async ([level, url])=>{
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`โหลดไม่ได้: ${url} (HTTP ${res.status})`);
      const raw = await res.json();
      const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.data) ? raw.data : []);
      if(!Array.isArray(arr)) throw new Error(`รูปแบบ JSON ของ ${level} ไม่ใช่อาร์เรย์`);
      const norm = arr.map(normalizeKeys);
      return [level, norm];
    }));
    ALL_DATA = Object.fromEntries(results);
  }catch(err){
    console.error(err);
    listEl.innerHTML = `<div class="card from-sheet" style="background:#fff1f2;border-color:#fca5a5;">เกิดข้อผิดพลาด: ${escapeHtml(err.message)}</div>`;
    throw err;
  }
}

// === RENDERERS ===
function buildFullDetail(item){
  const เรื่อง = (item['เรื่อง'] || '').trim();
  const คำแปล = (item['คำแปล'] || '').trim();
  const หมวด = (item['หมวด'] || '').trim();
  const ลำดับ = (item['ลำดับ'] || '').trim();

  let content = '<div class="from-sheet" style="line-height: 1.8;">';
  if (ลำดับ) content += `<p style="margin:0 0 10px;"><b>ลำดับ:</b> ${escapeHtml(ลำดับ)}</p>`;
  if (หมวด) content += `<p style="margin:0 0 10px;"><b>หมวด:</b> ${escapeHtml(หมวด)}</p>`;
  if (เรื่อง) content += `<p style="margin:0 0 10px;"><b>สุภาษิต:</b><br>${escapeHtml(เรื่อง)}</p>`;
  if (คำแปล) content += `<p style="margin:0 0 10px;"><b>คำแปล:</b><br><span style="white-space: pre-wrap;">${escapeHtml(คำแปล)}</span></p>`;
  content += '</div>';
  return content;
}

function cardTemplate(it, idx){
  return `<article class="card" data-idx="${idx}" role="button" tabindex="0" title="คลิกเพื่อดูรายละเอียด">
    <div class="meta from-sheet">
      ${pixelTag('ลำดับ '+escapeHtml(it['ลำดับ']||''))}
      ${pixelTag('หมวด '+escapeHtml(it['หมวด']||''))}
    </div>
    <div class="pali from-sheet">${escapeHtml(it['เรื่อง']||'')}</div>
    <div class="trans from-sheet">${escapeHtml(it['คำแปล']||'')}</div>
  </article>`;
}

function renderPage(){
  const total = filteredItems.length;
  if (!total){
    listEl.innerHTML = '<div class="card from-sheet">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</div>';
    pagerEl.hidden = true; return;
  }
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (page > totalPages) page = totalPages;
  const start = (page-1)*pageSize, end = Math.min(start+pageSize, total);

  const frag = document.createDocumentFragment();
  for(let i=start; i<end; i++){
    const it = filteredItems[i];
    const idx = currentLevelData.indexOf(it);
    const wrap = document.createElement('div');
    wrap.innerHTML = cardTemplate(it, idx);
    frag.appendChild(wrap.firstChild);
  }
  listEl.innerHTML = '';
  listEl.appendChild(frag);

  pagerEl.hidden = total <= pageSize;
  pageInfo.textContent = `หน้า ${page} / ${totalPages}`;
  prevBtn.disabled = page <= 1;
  nextBtn.disabled = page >= totalPages;
}

function refreshList(){
  try{
    listEl.innerHTML = '<div class="card from-sheet">กำลังประมวลผล…</div>';
    pagerEl.hidden = true;

    currentLevelData = ALL_DATA[state.level] || [];

    const q = (state.q||'').toLowerCase();
    filteredItems = currentLevelData.filter(item=>{
      const catOK = !state.category || item['หมวด'] === state.category;
      const qOK = !q ||
        (item['เรื่อง'] && item['เรื่อง'].toLowerCase().includes(q)) ||
        (item['คำแปล'] && item['คำแปล'].toLowerCase().includes(q));
      return catOK && qOK;
    });

    if (state.sort === 'cat'){
      filteredItems.sort((a,b)=>
        (a['หมวด']||'').localeCompare(b['หมวด']||'', 'th') ||
        (parseInt(a['ลำดับ'])||0) - (parseInt(b['ลำดับ'])||0)
      );
    }else{
      filteredItems.sort((a,b)=>
        (parseInt(a['ลำดับ'])||0) - (parseInt(b['ลำดับ'])||0)
      );
    }

    page = 1;
    renderPage();
  }catch(err){
    console.error(err);
    listEl.innerHTML = `<div class="card from-sheet" style="background:#fff1f2;border-color:#fca5a5;">ประมวลผลล้มเหลว: ${escapeHtml(err.message)}</div>`;
  }
}

// === DIALOGS / FILTER UI ===
function getUniqueValues(data, key){
  const values = data.map(x=>x[key]).filter(Boolean);
  return Array.from(new Set(values)).sort((a,b)=>String(a).localeCompare(String(b),'th'));
}
let temp = null;
function renderLevelChips(){
  const lv = ['นักธรรมตรี','นักธรรมโท','นักธรรมเอก'];
  document.getElementById('levelChips').innerHTML =
    lv.map(l=>`<button class="chip ${l===state.level?'is-active':''}" data-level="${l}">${l}</button>`).join('');
}
function renderDlgLevelChips(){
  const lv = ['นักธรรมตรี','นักธรรมโท','นักธรรมเอก'];
  dlgLevelChips.innerHTML =
    lv.map(l=>`<button class="chip ${l===(temp?.level||state.level)?'is-active':''}" data-dlg-level="${l}">${l}</button>`).join('');
}
function renderCats(){
  catsEl.innerHTML = (temp?.cats||[]).map(c=>`<div class="subcat ${c===temp.category?'is-active':''}" data-cat="${c}">${escapeHtml(c)}</div>`).join('');
}
function renderSubcats(){ subcatsEl.innerHTML = ''; }
function loadCats(){
  temp.cats = getUniqueValues(ALL_DATA[temp.level]||[], 'หมวด');
  temp.subcats = [];
  renderCats(); renderSubcats();
}

// === EVENTS ===
document.getElementById('openDlg').onclick = ()=>{ temp = JSON.parse(JSON.stringify(state)); renderDlgLevelChips(); loadCats(); dlg.showModal(); document.body.classList.add('lock'); };
document.getElementById('closeDlg').onclick= ()=>{ dlg.close(); document.body.classList.remove('lock'); };
document.getElementById('applyFilter').onclick= ()=>{ state = JSON.parse(JSON.stringify(temp)); dlg.close(); renderLevelChips(); refreshList(); };
document.getElementById('clearFilter').onclick= ()=>{ temp.category=''; temp.subcategory=''; renderCats(); renderSubcats(); };

document.addEventListener('click', (ev)=>{
  const l = ev.target.closest('.chip[data-level]');
  if(l){ state.level=l.dataset.level; state.category=''; state.subcategory=''; renderLevelChips(); refreshList(); return; }

  const dchip = ev.target.closest('.chip[data-dlg-level]');
  if(dchip){ if(temp.level !== dchip.dataset.dlgLevel){ temp.level=dchip.dataset.dlgLevel; temp.category=''; temp.subcategory=''; renderDlgLevelChips(); loadCats(); } return; }

  const c = ev.target.closest('.subcat[data-cat]');
  if(c){ temp.category=c.dataset.cat; renderCats(); return; }

  const card = ev.target.closest('.card[data-idx]');
  if(card){
    const idx = Number(card.dataset.idx);
    if(currentLevelData[idx]){ 
      infoContent.innerHTML = buildFullDetail(currentLevelData[idx]);
      dlgInfo.showModal(); 
      document.body.classList.add('lock'); 
    }
  }
});

document.getElementById('closeInfo').onclick = ()=>{ dlgInfo.close(); document.body.classList.remove('lock'); };
document.getElementById('okInfo').onclick    = ()=>{ dlgInfo.close(); document.body.classList.remove('lock'); };

// [ปรับปรุง] เปลี่ยน Event ของปุ่ม
document.getElementById('btnSearch').onclick = ()=>{ state.q = qEl.value.trim(); refreshList(); };
qEl.onkeydown = (e)=>{ if(e.key==='Enter'){ state.q = qEl.value.trim(); refreshList(); } };
sorterEl.onchange = ()=>{ state.sort = sorterEl.value; refreshList(); };
prevBtn.onclick = ()=>{ if(page>1){ page--; renderPage(); window.scrollTo(0,0); } };
nextBtn.onclick = ()=>{ const totalPages = Math.max(1, Math.ceil(filteredItems.length/pageSize)); if(page<totalPages){ page++; renderPage(); window.scrollTo(0,0); } };
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && dlg.open){ dlg.close(); document.body.classList.remove('lock'); } if(e.key==='Escape' && dlgInfo.open){ dlgInfo.close(); document.body.classList.remove('lock'); } });

// === INIT ===
async function init(){
  renderLevelChips();
  try{
    await loadAllDataFromFiles();
    refreshList();
  }catch(e){ /* แสดงแล้วในหน้าจอ */ }
}
init();
</script>
<a class="dlg-head" href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%B8%E0%B8%A3%E0%B8%81" target="_blank" style="display: block; text-align: center; padding: 10px; text-decoration: none;">
  <div class="title">นโยบายส่วนตัว Privacy policy</div>
</a>
</body>
</html>
