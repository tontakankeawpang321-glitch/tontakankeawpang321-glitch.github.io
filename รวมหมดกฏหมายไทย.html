<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Lite + Chips + Slider)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>

<script type="module" src="https://unpkg.com/@google/generative-ai"></script>

<style>
  :root{
    /* ‚öñÔ∏è ‡πÇ‡∏ó‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    --bg:#ffffff;
    --ink:#0f1a2b;
    --muted:#6b7280;
    --line:#e6e8ee;
    --brand:#173b74;      /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏£‡∏°‡∏ó‡πà‡∏≤ */
    --gold:#f5d66d;        /* ‡∏ó‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô */
    --ivory:#fffdf5;      /* ‡∏Ñ‡∏£‡∏µ‡∏° */
    --radius:14px;
    --shadow-sm:0 3px 0 rgba(15,26,43,.18), 0 10px 22px -18px rgba(0,0,0,.18);
    --shadow-inset: inset 0 2px 0 rgba(255,255,255,.9), inset 0 -3px 0 rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Sarabun", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial, sans-serif;
    font-size:14px
  }
  h1,h2,h3,h4{margin:0 0 8px}
  .wrap{max-width:980px;margin:0 auto;padding:12px 12px 28px}
  .section{margin-top:12px}

  /* ‡∏Å‡∏•‡πà‡∏≠‡∏á/‡∏Å‡∏≤‡∏£‡πå‡∏î */
  .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:0 10px 20px -18px rgba(0,0,0,.18)}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .row h3{color:var(--brand)}
  .note{color:var(--muted);font-size:12px}

  /* ‡∏õ‡∏∏‡πà‡∏° 3D ‡πÇ‡∏ó‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ */
  .btn{
    appearance:none;border:1px solid #d7dbe6;background:linear-gradient(#ffffff,#f7f9fd);
    padding:10px 14px;border-radius:12px;cursor:pointer;color:#0f1a2b;font-weight:700;
    box-shadow:var(--shadow-sm),var(--shadow-inset);transform:translateY(0);
    transition:transform .05s, box-shadow .1s, filter .15s; text-shadow:0 1px 0 rgba(255,255,255,.9);
  }
  .btn:hover{filter:brightness(1.02)}
  .btn:active{transform:translateY(2px);box-shadow:0 1px 0 rgba(15,26,43,.18), 0 6px 14px -10px rgba(0,0,0,.15), inset 0 2px 0 rgba(0,0,0,.06)}
  .btn.primary{border-color:#e7dba9;background:linear-gradient(var(--ivory), #ffeaa8)}
  .btn.secondary{background:linear-gradient(#ffffff,#f4f6fb);border-color:#d7dbe6}

  /* ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
  .searchbar{display:flex;gap:8px;margin:8px 0 12px}
  .searchbar input{flex:1;height:42px;padding:0 12px;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:inset 0 2px 6px rgba(0,0,0,.03)}

  /* ‡∏ä‡∏¥‡∏õ‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏ç‡πà (Fixed 6 ‡∏´‡∏°‡∏ß‡∏î) */
  .catbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  .chip{
    display:flex;align-items:center;gap:8px;justify-content:center;
    padding:14px 12px;border-radius:18px;border:1px solid var(--line);
    background:linear-gradient(#ffffff,#f6f7fb);
    box-shadow:0 8px 20px -16px rgba(0,0,0,.18);
    cursor:pointer;font-weight:800;color:var(--ink);
  }
  .chip .emoji{font-size:18px}
  .chip.active{border-color:#d9e1f2;background:linear-gradient(#f7fbff,#eef3ff);color:var(--brand)}
  .chip:focus-visible{outline:2px solid #b6c6ff;outline-offset:2px}

  /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
  .list{display:grid;gap:10px;margin-top:10px}
  .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;box-shadow:0 8px 18px -16px rgba(0,0,0,.15)}
  .title{margin:0 0 4px;font-weight:800;color:var(--brand)}
  .meta{display:flex;gap:6px;flex-wrap:wrap;color:var(--muted);font-size:12px}
  .tag{background:#f7f9ff;border:1px solid #e2e7f2;border-radius:999px;padding:2px 8px}
  .actions{margin-top:8px}
  .link{
    display:inline-block;font-weight:800;border:1px solid #e7dba9;border-radius:10px;padding:6px 12px;text-decoration:none;
    color:#3b2f0a;background:linear-gradient(var(--ivory), #ffeaa8);box-shadow:var(--shadow-sm),var(--shadow-inset)
  }
  .link:active{transform:translateY(2px)}

  /* ‡∏™‡πÑ‡∏•‡∏î‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î */
  .latest-slider{position:relative}
  .latest-viewport{overflow:hidden;border:1px solid var(--line);border-radius:12px;background:#fff}
  .latest-track{display:flex;transition:transform .35s ease;will-change:transform}
  .latest-slide{min-width:100%;padding:12px;display:grid;grid-template-columns:1fr;gap:6px;border-right:1px solid var(--line)}
  .latest-slide h4{margin:0 0 4px;font-size:14px;font-weight:800;color:var(--brand)}
  .latest-slide .meta{display:flex;gap:6px;flex-wrap:wrap;color:var(--muted);font-size:12px}
  .dots{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:8px}
  .dot{width:6px;height:6px;border-radius:50%;background:#d9e1f2;opacity:.95}
  .dot.active{background:#1f3d75}

  .loadbar{display:flex;justify-content:center;gap:8px;margin-top:10px}
  .empty{padding:18px;text-align:center;color:var(--muted);border:1px dashed var(--line);border-radius:12px;background:#fff}

  @media (max-width:420px){ .catbar{grid-template-columns:1fr 1fr} }

  /* ===== CSS ‡∏Ç‡∏≠‡∏á Chatbot ===== */
  .chat-bubble::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
  }
  .chat-bubble-user::before {
    border-width: 0 12px 12px 12px;
    border-color: transparent transparent #3b82f6 transparent;
    top: -10px;
    right: 12px;
  }
  .chat-bubble-model::before {
    border-width: 0 12px 12px 12px;
    border-color: transparent transparent #e5e7eb transparent;
    top: -10px;
    left: 12px;
  }
  .gemini-thinking-bar {
    position: relative;
    width: 100%;
    height: 4px;
    background-color: #e0e0e0;
    border-radius: 2px;
    overflow: hidden;
  }
  .gemini-thinking-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #4285F4, #34A853, #FBBC05, #EA4335, #4285F4);
    background-size: 200% 100%;
    animation: thinking-gradient 2s linear infinite;
  }
  @keyframes thinking-gradient {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  
  /* CSS ‡∏Ç‡∏≠‡∏á FAB ‡πÅ‡∏•‡∏∞ Modal */
  #fab-chat-toggle {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 60px;
    height: 60px;
    background-color: var(--brand, #173b74); /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ */
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 28px;
    line-height: 60px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 998;
    transition: transform 0.2s, opacity 0.3s;
  }
  #fab-chat-toggle:hover {
    transform: scale(1.05);
  }
  #chatbot-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    transition: opacity 0.3s, transform 0.3s;
    opacity: 1;
    transform: translateY(0);
  }
  #chatbot-modal.chatbot-hidden {
    opacity: 0;
    transform: translateY(100%);
    pointer-events: none;
  }
</style>
</head>
<body>

<main class="wrap">
  <section class="section">
    <div class="panel latest-slider">
      <div class="row"><h3>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3><span class="note">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span></div>
      <div class="latest-viewport" id="latestViewport"><div id="latestTrack" class="latest-track" aria-live="polite"></div></div>
      <div id="dots" class="dots" aria-hidden="true"></div>
    </div>
  </section>
  <section class="section">
    <div class="searchbar" role="search">
      <input id="q" type="search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏•‡πà‡∏°‡∏ï‡∏≠‡∏ô/‡∏´‡∏°‡∏ß‡∏î)..." aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢">
      <button id="btnSearch" class="btn primary" type="button">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
  </section>
  <section class="section">
    <div class="catbar" id="catbar" role="tablist" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢">
      </div>
    <div class="panel" style="margin-top:8px">
      <div class="row">
        <h3 id="panelTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
        <div id="panelNote" class="note">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      </div>
      <div id="list" class="list"></div>
      <div class="loadbar">
        <button id="btnPrev" class="btn secondary" type="button" style="display:none">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <button id="btnNext" class="btn primary" type="button" style="display:none">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </section>
</main>


<button id="fab-chat-toggle" title="‡πÄ‡∏õ‡∏¥‡∏î Thai Law AI">‚öñÔ∏è</button>
<div id="chatbot-modal" class="chatbot-hidden">
  <div class="flex flex-col h-screen bg-gray-100">
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md">
      <h1 class="text-xl font-semibold">Thai Law AI - ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢</h1>
      <div>
        <button id="new-chat-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
          ‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà
        </button>
        <button id="chatbot-close-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
          ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </header>
    <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4">
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-gray-200 text-gray-800 p-3 rounded-lg max-w-lg relative">
          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ Thai Law AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÅ‡∏•‡πâ‡∏ß)</p>
        </div>
      </div>
    </main>
    <div id="thinking-indicator" class="p-4 hidden">
      <div class="flex items-center space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-gray-200 text-gray-800 p-3 rounded-lg max-w-lg relative">
          <div class="gemini-thinking-bar"></div>
        </div>
      </div>
    </div>
    <footer class="bg-white p-4 shadow-inner">
      <div class="flex space-x-2">
        <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
          ‡∏™‡πà‡∏á
        </button>
      </div>
    </footer>
  </div>
</div>


<script>
/* ===== ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ===== */
const PAGE_SIZE = 5;
let lawsData = [];
async function loadJsonAndStart() {
  try {
    const res = await fetch("./lawsData.json", { cache: "no-store" });
    lawsData = await res.json();
    renderChips();
    loadAllData();
    const u = new URL(location.href);
    const initQ = u.searchParams.get("q") || "";
    if (initQ) { document.querySelector("#q").value = initQ; doSearch(); }
  } catch (e) {
    console.error("‡πÇ‡∏´‡∏•‡∏î lawsData.json ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e);
    document.getElementById("list").innerHTML =
      `<div class="empty">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>`;
  }
}

/* * ==================================================================
 * ‚ùóÔ∏è‚ùóÔ∏è ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö lawsData.json ‚ùóÔ∏è‚ùóÔ∏è
 * ================================================================== 
 */
const COLS = { 
  category: "‡∏´‡∏°‡∏ß‡∏î", 
  title: "‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢", 
  date: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", 
  volume: "‡πÄ‡∏•‡πà‡∏°‡∏ï‡∏≠‡∏ô",  // <-- ‡πÉ‡∏ä‡πâ "‡πÄ‡∏•‡πà‡∏°‡∏ï‡∏≠‡∏ô"
  url: "URL_PD"     // <-- ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô "URL_PD" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö JSON
};
const col = k => COLS[k];

const FIXED_CATS = [
  {key:"‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢",      label:"‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢",      emoji:"üìö"},
  {key:"‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç",          label:"‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç",          emoji:"üìú"},
  {key:"‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤",     label:"‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤",     emoji:"üèõÔ∏è"},
  {key:"‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏≥‡∏´‡∏ô‡∏î",       label:"‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏≥‡∏´‡∏ô‡∏î",       emoji:"üìò"},
  {key:"‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥",      label:"‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥",      emoji:"üìñ"},
  {key:"‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£",        label:"‡∏Å‡∏é‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á",          emoji:"üß∑"}
];
function normalizeCatName(raw=""){
  const s = (raw||"").trim();
  const map = new Map([
    ["‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢","‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢"], ["‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏è‡∏´‡∏°‡∏≤‡∏¢","‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢"], // <-- ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
    ["‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç","‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç"],
    ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤"], ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏Å‡∏é‡∏µ‡∏Å‡∏≤","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤"], ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏é‡∏µ‡∏Å‡∏≤","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤"],
    ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏≥‡∏´‡∏ô‡∏î","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏Å‡∏≥‡∏´‡∏ô‡∏î"],
    ["‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥","‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥"],
    ["‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£","‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£"], ["‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£","‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£"]
  ]);
  return map.get(s) || s;
}
const $ = (s,el=document)=>el.querySelector(s);
function sanitizeUrl(u=''){
  try{ const url=new URL(u, location.origin); if(url.protocol==='http:'||url.protocol==='https://') return url.href; }catch{}
  return '';
}
const TH_MONTHS={'‡∏°.‡∏Ñ.':1,'‡∏Å.‡∏û.':2,'‡∏°‡∏µ.‡∏Ñ.':3,'‡πÄ‡∏°.‡∏¢.':4,'‡∏û.‡∏Ñ.':5,'‡∏°‡∏¥.‡∏¢.':6,'‡∏Å.‡∏Ñ.':7,'‡∏™.‡∏Ñ.':8,'‡∏Å.‡∏¢.':9,'‡∏ï.‡∏Ñ.':10,'‡∏û.‡∏¢.':11,'‡∏ò.‡∏Ñ.':12,'‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°':1,'‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå':2,'‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°':3,'‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô':4,'‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°':5,'‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô':6,'‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°':7,'‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°':8,'‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô':9,'‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°':10,'‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô':11,'‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°':12};
function thDigitsToArabic(s=''){const m={'‡πê':'0','‡πë':'1','‡πí':'2','‡πì':'3','‡πî':'4','‡πï':'5','‡πñ':'6','‡πó':'7','‡πò':'8','‡πô':'9'}; return s.replace(/[‡πê-‡πô]/g,ch=>m[ch]??ch);}
function parseDateTS(s){
  if(!s) return 0; s=s.trim();
  const onlyBuddhist = s.match(/^‡∏û\.‡∏®\.?\s*([0-9‡πê-‡πô]{4})$/);
  if(onlyBuddhist){ let y=parseInt(thDigitsToArabic(onlyBuddhist[1]),10)-543; return new Date(y,0,1).getTime(); }
  const th = s.match(/^([0-9‡πê-‡πô]{1,2})\s+([‡∏Å-‡πô\.]+)\s+([0-‡πô0-9]{4})$/);
  if(th){
    const d=parseInt(thDigitsToArabic(th[1]),10);
    const m=TH_MONTHS[th[2]]||0;
    let y=parseInt(thDigitsToArabic(th[3]),10);
    if(y>2400) y-=543;
    return (m&&d&&y)? new Date(y,m-1,d).getTime():0;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ let [y,m,d]=s.split('-').map(n=>+n); if(y>2400) y-=543; return new Date(y,(m||1)-1,(d||1)).getTime(); }
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){ let [d,m,y]=s.split('/').map(n=>+n); if(y>2400) y-=543; return new Date(y,(m||1)-1,(d||1)).getTime(); }
  return 0;
}
function fmtDateThai(s){
  if(!s) return '';
  if(/^[0-9]{4}-/.test(s)||/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
    let y,m,d;
    if(s.includes('-')){[y,m,d]=s.split('-').map(n=>+n);} else{[d,m,y]=s.split('/').map(n=>+n);}
    if(y<2400) y+=543;
    const mm=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
    return `${d} ${mm[(m||1)-1]} ${y}`;
  }
  return s;
}
const catbar = $("#catbar");
const listEl = $("#list");
const btnNext = $("#btnNext");
const btnPrev = $("#btnPrev");
const panelTitle = $("#panelTitle");
const panelNote = $("#panelNote");
const CatState = {};
let selectedCat = null;
const allIndex = [];
let LatestData = [];
function escapeHtml(s){return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function renderCard(r){
  const t=r[col('title')]||'', d=r[col('date')]||'', v=r[col('volume')]||'', c=r[col('category')]||'', u=r[col('url')]||'';
  const safe = sanitizeUrl(u);
  return `<article class="card">
    <h4 class="title">${escapeHtml(t)||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)'}</h4>
    <div class="meta">
      ${c?`<span class="tag">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(c)}</span>`:''}
      ${d?`<span class="tag">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${escapeHtml(fmtDateThai(d))}</span>`:''}
      ${v?`<span class="tag">‡πÄ‡∏•‡πà‡∏°+‡∏ï‡∏≠‡∏ô: ${escapeHtml(v)}</span>`:''}
    </div>
    <div class="actions">
      ${safe?`<a class="link" href="${safe}" target="_blank" rel="noopener noreferrer">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡πà‡∏≤‡∏ô</a>`:`<span class="note">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå</span>`}
    </div>
  </article>`;
}
function renderChips(){
  catbar.innerHTML = FIXED_CATS.map(c => `
    <button class="chip" type="button" role="tab" aria-selected="false" data-cat="${c.key}">
      <span class="emoji">${c.emoji}</span><span>${c.label}</span>
    </button>
  `).join('');
}
function loadAllData(){
  listEl.innerHTML=`<div class="empty">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
  try {
    FIXED_CATS.forEach(({key}) => {
        CatState[key] = {rows: [], page: 0, loaded: true};
    });
    lawsData.forEach(item => {
        const normCat = normalizeCatName(item[col('category')]);
        if (CatState[normCat]) {
            const processedItem = {...item, _ts: parseDateTS(item[col('date')])};
            CatState[normCat].rows.push(processedItem);
            allIndex.push(processedItem);
        }
    });
    FIXED_CATS.forEach(({key}) => {
        if (CatState[key].rows.length > 0) {
            CatState[key].rows.sort((a, b) => (b._ts || 0) - (a._ts || 0));
            LatestData.push({cat: key, row: CatState[key].rows[0]});
        }
    });
    catbar.addEventListener('click', e=>{
      const b=e.target.closest('button[data-cat]'); if(!b) return;
      selectCategory(b.dataset.cat); b.focus();
    });
    catbar.addEventListener('keydown', e=>{
      const chips=[...catbar.querySelectorAll('.chip')];
      if(!chips.length) return;
      const i=chips.findIndex(t=>t.dataset.cat===selectedCat);
      if(e.key==='ArrowRight'||e.key==='ArrowDown'){
        const n=chips[(i+1+chips.length)%chips.length]; selectCategory(n.dataset.cat); n.focus(); e.preventDefault();
      }else if(e.key==='ArrowLeft'||e.key==='ArrowUp'){
        const p=chips[(i-1+chips.length)%chips.length]; selectCategory(p.dataset.cat); p.focus(); e.preventDefault();
      }
    });
    selectCategory(FIXED_CATS[0].key);
    buildLatestSlider();
  } catch(e) {
    listEl.innerHTML=`<div class="empty">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
    console.error(e);
  }
}
function renderPage(cat){
  const st=CatState[cat]; if(!st) return;
  const start=st.page*PAGE_SIZE, end=start+PAGE_SIZE;
  const slice=st.rows.slice(start,end);
  listEl.innerHTML = slice.length? slice.map(renderCard).join('') : `<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
  btnPrev.style.display = (st.page>0)? 'inline-block':'none';
  btnNext.style.display = (end < st.rows.length)? 'inline-block':'none';
  panelTitle.textContent = `${cat} ‚Äî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î`;
  panelNote.textContent  = `‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ ${PAGE_SIZE} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏° ${st.rows.length})`;
}
function selectCategory(cat){
  if(selectedCat===cat) return;
  selectedCat=cat;
  [...catbar.querySelectorAll('.chip')].forEach(b=>{
    const on = b.dataset.cat===cat;
    b.classList.toggle('active', on);
    b.setAttribute('aria-selected', on?'true':'false');
    b.setAttribute('tabindex', on?'0':'-1');
  });
  if(CatState[cat]){
    CatState[cat].page=0;
    renderPage(cat);
  } else {
    listEl.innerHTML = `<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${cat}"</div>`;
  }
}
btnNext.addEventListener('click', ()=>{
  if(!selectedCat) return;
  const st=CatState[selectedCat]; if(!st) return;
  st.page+=1; renderPage(selectedCat);
});
btnPrev.addEventListener('click', ()=>{
  if(!selectedCat) return;
  const st=CatState[selectedCat]; if(!st) return;
  if(st.page>0){ st.page-=1; renderPage(selectedCat); }
});
const elQ = $("#q"), elBtnSearch=$("#btnSearch");
elBtnSearch.addEventListener('click', doSearch);
elQ.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
function normalizeThai(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim().normalize('NFC').replace(/[\u0E31\u0E34-\u0E3A\u0E47-\u0E4E]/g,''); }
function doSearch(){
  const q=(elQ.value||'').trim();
  if(!q){ if(selectedCat) renderPage(selectedCat); return; }
  const nq=normalizeThai(q);
  const results = allIndex.filter(o=>{
    const t=normalizeThai(o[col('title')]||''),
          v=normalizeThai(o[col('volume')]||''),
          c=normalizeThai(o[col('category')]||'');
    return t.includes(nq)||v.includes(nq)||c.includes(nq);
  }).sort((a,b)=>(b._ts||0)-(a._ts||0));
  listEl.innerHTML = results.slice(0,50).map(renderCard).join('') || `<div class="empty">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>`;
  btnNext.style.display='none';
  btnPrev.style.display='none';
  panelTitle.textContent = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‚Äú${q}‚Äù`;
  panelNote.textContent  = `‡∏û‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 50 ‡πÅ‡∏£‡∏Å)`;
}
const latestViewport = $("#latestViewport");
const latestTrack = $("#latestTrack");
const dotsEl = $("#dots");
let latestSlides=[]; let latestIndex=0; let autoTimer=null;
function updateLatestSlider(){
  const w = latestViewport.getBoundingClientRect().width;
  latestTrack.style.transform = `translateX(${-latestIndex*w}px)`;
  [...dotsEl.children].forEach((d,i)=>d.classList.toggle('active', i===latestIndex));
}
function nextLatest(){ if(!latestSlides.length) return; latestIndex = (latestIndex + 1) % latestSlides.length; updateLatestSlider(); }
function startAuto(){ stopAuto(); autoTimer = setInterval(nextLatest, 4000); }
function stopAuto(){ if(autoTimer){ clearInterval(autoTimer); autoTimer=null; } }
document.addEventListener('visibilitychange', ()=>{ document.hidden ? stopAuto() : startAuto(); });
latestViewport.addEventListener('mouseenter', stopAuto);
latestViewport.addEventListener('mouseleave', startAuto);
window.addEventListener('resize', updateLatestSlider);
function buildLatestSlider(){
  latestTrack.innerHTML=''; dotsEl.innerHTML='';
  latestSlides = LatestData.filter(Boolean).sort((a,b)=>(b.row._ts||0) - (a.row._ts||0));
  if(!latestSlides.length){
    latestTrack.innerHTML = `<div class="latest-slide"><div class="meta">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div></div>`;
    return;
  }
  latestTrack.innerHTML = latestSlides.map(({cat,row})=>{
    const t=row[col('title')]||'', d=row[col('date')]||'', u=row[col('url')]||'#';
    const safe = sanitizeUrl(u);
    return `<div class="latest-slide">
      <h4>${escapeHtml(t)||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)'}</h4>
      <div class="meta"><span class="tag">‡∏´‡∏°‡∏ß‡∏î: ${escapeHtml(cat)}</span><span class="tag">${escapeHtml(fmtDateThai(d))}</span></div>
      ${safe?`<div class="actions" style="margin-top:6px"><a class="link" href="${safe}" target="_blank" rel="noopener noreferrer">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡πà‡∏≤‡∏ô</a></div>`:''}
    </div>`;
  }).join('');
  dotsEl.innerHTML = latestSlides.map((_,i)=>`<span class="dot ${i===0?'active':''}"></span>`).join('');
  latestIndex=0; updateLatestSlider(); startAuto();
}
loadJsonAndStart();
</script>


<script type="module"> 
  
  // --- ‡∏™‡πà‡∏ß‡∏ô API Key ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI ---
  
  // ‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è ‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è
  const API_KEY = "AQ.Ab8RN6IZwR8pe4fJB1j8Cp7dsx4EyoY7CktNHVpLqx1TLVdm5g"; 
  // ‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ AI ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) ‚ùóÔ∏è‚ùóÔ∏è‚ùóÔ∏è

  // (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ SDK ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô <head>)
  const { GoogleGenerativeAI } = await import("https://unpkg.com/@google/generative-ai?module");

  let genAI;
  let model;
  let chat;

  try {
    genAI = new GoogleGenerativeAI(API_KEY);

    /* * ==================================================================
     * ‚ùóÔ∏è‚ùóÔ∏è ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏õ‡πá‡∏ô gemini-1.5-flash ‚ùóÔ∏è‚ùóÔ∏è
     * ================================================================== 
     */
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤)
    chat = model.startChat();
  } catch (e) {
    console.error("AI Initialization Error:", e);
    // (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á)
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Chatbot (UI) ---
  const chatHistory = document.getElementById('chat-history');
  const userInput = document.getElementById('user-input');
  const sendBtn = document.getElementById('send-btn');
  const newChatBtn = document.getElementById('new-chat-btn');
  const thinkingIndicator = document.getElementById('thinking-indicator');

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° Bubble ‡πÅ‡∏ä‡∏ó
  function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    const bubbleWrapper = document.createElement('div');
    bubbleWrapper.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubbleContent = document.createElement('div');
    bubbleContent.className = `chat-bubble chat-bubble-${bubbleType} ${isUser ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} p-3 rounded-lg max-w-lg relative`;
    bubbleContent.innerHTML = `<p></p>`;
    // (‡πÉ‡∏ä‡πâ .innerText ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó)
    bubbleContent.querySelector('p').innerText = message; 
    
    bubbleWrapper.innerHTML = `<span class="text-2xl">${icon}</span>`;
    bubbleWrapper.appendChild(bubbleContent);

    chatHistory.appendChild(bubbleWrapper);
    chatHistory.scrollTop = chatHistory.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
  function addChatError(message) {
    const errorWrapper = document.createElement('div');
    errorWrapper.className = 'flex justify-center my-2';
    errorWrapper.innerHTML = `<span class="bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">${message}</span>`;
    chatHistory.appendChild(errorWrapper);
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î
  function setThinking(isThinking) {
    if (isThinking) {
      thinkingIndicator.classList.remove('hidden');
      chatHistory.scrollTop = chatHistory.scrollHeight;
    } else {
      thinkingIndicator.classList.add('hidden');
    }
  }

  // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° AI ‡∏à‡∏£‡∏¥‡∏á) ---
  async function handleSend() {
    const message = userInput.value.trim();
    if (!message) return;

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ AI ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!genAI || !chat) {
      addChatError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô AI ‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key)");
      setThinking(false);
      return;
    }

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    sendBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß

    try {
      // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà AI ‡∏à‡∏£‡∏¥‡∏á
      const result = await chat.sendMessage(message);
      const response = await result.response;
      const text = response.text();

      // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
      setThinking(false);
      addChatBubble(text, false); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å AI

    } catch (error) {
      // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
      console.error("AI Error:", error);
      setThinking(false);
      addChatError("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö AI (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°)");
    } finally {
      sendBtn.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
    }
  }

  // --- Event Listeners ---
  sendBtn.addEventListener('click', handleSend);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  newChatBtn.addEventListener('click', () => {
    // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏ô‡∏à‡∏≠
    chatHistory.innerHTML = `
      <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-gray-200 text-gray-800 p-3 rounded-lg max-w-lg relative">
          <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß)</p>
        </div>
      </div>
    `;
    userInput.value = '';
    setThinking(false);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á session ‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô AI ‡∏î‡πâ‡∏ß‡∏¢
    if (model) {
      chat = model.startChat();
    }
  });


  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î (Glue) ---
  const fabToggle = document.getElementById('fab-chat-toggle');
  const chatModal = document.getElementById('chatbot-modal');
  const chatbotCloseBtn = document.getElementById('chatbot-close-btn');

  fabToggle.addEventListener('click', () => {
    chatModal.classList.remove('chatbot-hidden');
    fabToggle.style.opacity = '0';
  });

  chatbotCloseBtn.addEventListener('click', () => {
    chatModal.classList.add('chatbot-hidden');
    fabToggle.style.opacity = '1';
  });
</script>

</body>
</html>


